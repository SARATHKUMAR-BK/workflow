name: CLDP Promotion Job
on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform (aws,azure,all)"
        default: aws
        required: true
        options:
        - foo
        - bar
        - baz
      source_env:
        description: "Source Environment(dev,int,stage,spro)"
        default: dev
        required: true
      target_env:
        description: "Target Environment(int,stage,preprod)"
        default: int
        required: true
      components:
        description: "Components to promote (universal-messaging,terracotta-server)"
        default: terracotta-server
        required: true
      tags:
        description: "Tags of corresponding components (applicable for dev and spro source envs)"
        required: false
      app_version:
        description: "Current App Version"
        default: "1012"
        required: true
jobs:
  Promote-Images:
    runs-on: ubuntu-latest
    steps:
       - uses: actions/checkout@v2
         name: Checkout the current repository
         
       - name: Configure AWS Credentials for s3
         uses: aws-actions/configure-aws-credentials@v1
         with:
          aws-access-key-id: ${{ secrets.ACCESSKEY }}
          aws-secret-access-key: ${{ secrets.SECRETKEY }}
          aws-region: ${{ secrets.AWS_REGION }}
       -  name: ECR RnD Login
          id: ecr-login
          uses: aws-actions/amazon-ecr-login@v1
          if: github.event.inputs.platform == 'aws' || github.event.inputs.platform == 'all'
          
       - name: AWS Preprod login
         uses: aws-actions/configure-aws-credentials@v1
         with:
            aws-access-key-id: ${{ secrets.AWS_PREPROD_ACCESS_KEY }}
            aws-secret-access-key: ${{ secrets.AWS_PREPROD_SECRET_KEY }}
            aws-region: ${{ secrets.AWS_PREPROD_REGION }}
         if: github.event.inputs.target_env == 'preprod' && (github.event.inputs.platform == 'aws' || github.event.inputs.platform == 'all') 
       - name: ECR Preprod Login
         id: ecr-preprod-login
         uses: aws-actions/amazon-ecr-login@v1
         if: github.event.inputs.target_env == 'preprod' && (github.event.inputs.platform == 'aws' || github.event.inputs.platform == 'all')

       - name: Configure AWS Credentials for s3
         uses: aws-actions/configure-aws-credentials@v1
         with:
          aws-access-key-id: ${{ secrets.ACCESSKEY }}
          aws-secret-access-key: ${{ secrets.SECRETKEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
       - name: Set up Reg URLs
         id: img-regs
         run: |
          aws s3 ls s3://cldp/buildfiles/
          docker pull ${{ steps.ecr-login.outputs.registry }}/lj:10.12
          docker pull ${{ steps.ecr-preprod-login.outputs.registry }}/b2b/webmethods-b2b:10.12.0
          aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin ${{ steps.ecr-preprod-login.outputs.registry }}
          aws ecr describe-repositories
          aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin ${{ steps.ecr-login.outputs.registry }}
          aws ecr describe-repositories         
          
          echo "::set-output name=AWS_SOURCE_REG_URL::${{ steps.ecr-login.outputs.registry }}"
          if [[ github.event.inputs.target_env == 'preprod' ]]
          then
            echo "::set-output name=AWS_TARGET_REG_URL::${{ steps.ecr-preprod-login.outputs.registry }}"
          else
            echo "::set-output name=AWS_TARGET_REG_URL::${{ steps.ecr-login.outputs.registry }}"
          fi
       - name: Promote Images to Env
         uses: ./image-deployment/actions/promote-image
         with:
          platform: ${{ github.event.inputs.platform }}
          source_env: ${{ github.event.inputs.source_env }}
          target_env: ${{ github.event.inputs.target_env }}
          components: ${{ github.event.inputs.components }}
          tags: ${{ github.event.inputs.tags }}
          app_version: ${{ github.event.inputs.app_version }}
          bucket_name: cldp
          metadata_path: buildfiles
          source_aws_registry: ${{ steps.img-regs.outputs.AWS_SOURCE_REG_URL }}
          target_aws_registry: ${{ steps.img-regs.outputs.AWS_TARGET_REG_URL }}
        
        
       - name: AWS Preprod login
         uses: aws-actions/configure-aws-credentials@v1
         with:
            aws-access-key-id: ${{ secrets.AWS_PREPROD_ACCESS_KEY }}
            aws-secret-access-key: ${{ secrets.AWS_PREPROD_SECRET_KEY }}
            aws-region: ${{ secrets.AWS_PREPROD_REGION }}
       - name: ECR Preprod Login
         uses: aws-actions/amazon-ecr-login@v1
         id: pre
       - name: shell
         run:  |
             docker tag ${{ steps.img-regs.outputs.AWS_SOURCE_REG_URL }}/${{ github.event.inputs.components }}:${{ github.event.inputs.tags }} ${{ steps.pre.outputs.registry }}/${{ github.event.inputs.components }}:${{ github.event.inputs.tags }}
             docker images
             docker push ${{ steps.pre.outputs.registry }}/${{ github.event.inputs.components }}:${{ github.event.inputs.tags }}
             aws ecr describe-repositories | jq -r .repositories[].repositoryName
